---
import FormHero from '@components/FormHero.astro';
import globalSettings from '@config/config.json.ts';
import BaseLayout from "@layouts/BaseLayout.astro";
import en from '@/locales/en.json';

const t = await import(/* @vite-ignore */ `@locales/${globalSettings.language}.json`)
  .catch(() => import(/* @vite-ignore */ '@locales/en.json'));

---

<BaseLayout globalSettings={globalSettings} t={t} title="ç³»çµ±ç‹€æ…‹æª¢æ¸¬" description="æª¢æŸ¥ç³»çµ±é€£æ¥ç‹€æ…‹å’Œæœå‹™å¯ç”¨æ€§">
    <main>
        <FormHero type={"SystemStatus"} t={t} globalSettings={globalSettings} title="ğŸ” ç³»çµ±ç‹€æ…‹æª¢æ¸¬" description="ç›£æ§ç³»çµ±é€£æ¥ç‹€æ…‹å’Œæœå‹™å¯ç”¨æ€§">
            <div class="system-status-container">
                
                <div class="status-container">
                    <h2>é€£æ¥ç‹€æ…‹</h2>
                    
                    <div class="status-item">
                        <span>ğŸŒ å¾Œç«¯ API æœå‹™å™¨</span>
                        <div class="status-indicator status-loading" id="api-status">â³</div>
                    </div>
                    
                    <div class="status-item">
                        <span>ğŸ” ç”¨æˆ¶èªè­‰ç³»çµ±</span>
                        <div class="status-indicator status-loading" id="auth-status">â³</div>
                    </div>
                    
                    <div class="status-item">
                        <span>ğŸ—„ï¸ æ•¸æ“šåº«é€£æ¥</span>
                        <div class="status-indicator status-loading" id="db-status">â³</div>
                    </div>
                    
                    <div class="status-item">
                        <span>ğŸ“„ éœæ…‹æ–‡ä»¶æœå‹™</span>
                        <div class="status-indicator status-loading" id="static-status">â³</div>
                    </div>
                    
                    <div class="status-item">
                        <span>ğŸ”” é€šçŸ¥ç³»çµ±</span>
                        <div class="status-indicator status-loading" id="notify-status">â³</div>
                    </div>
                </div>
                
                <div class="test-section">
                    <h2>ç™»éŒ„æ¸¬è©¦</h2>
                    <div class="test-form">
                        <input type="email" id="test-email" placeholder="æ¸¬è©¦éƒµç®±" value="test@example.com">
                        <input type="password" id="test-password" placeholder="æ¸¬è©¦å¯†ç¢¼" value="testpass123">
                        <button onclick="testLogin()">æ¸¬è©¦ç™»éŒ„</button>
                        <button onclick="testSignup()">æ¸¬è©¦è¨»å†Š</button>
                        <button onclick="refreshStatus()">åˆ·æ–°ç‹€æ…‹</button>
                    </div>
                    
                    <div class="log-container" id="log-container">
                        <div class="log-entry">ç­‰å¾…æ¸¬è©¦...</div>
                    </div>
                </div>
                
                <div class="system-info">
                    <h2>ç³»çµ±ä¿¡æ¯</h2>
                    <div id="system-info-content">
                        <div class="info-item">
                            <span>ç•¶å‰æ™‚é–“:</span>
                            <span id="current-time"></span>
                        </div>
                        <div class="info-item">
                            <span>ç€è¦½å™¨:</span>
                            <span id="browser-info"></span>
                        </div>
                        <div class="info-item">
                            <span>é€£æ¥ç‹€æ…‹:</span>
                            <span id="connection-info">æª¢æ¸¬ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </FormHero>
    </main>
</BaseLayout>

<style>
    .system-status-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .status-container, .test-section, .system-info {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        background: #f8f9fa;
    }
    
    .status-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
    }
    
    .status-success { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; color: #000; }
    .status-loading { 
        background-color: #007bff; 
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .test-form {
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    
    .test-form input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 200px;
    }
    
    .test-form button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .test-form button:hover {
        background: #0056b3;
    }
    
    .log-container {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
    }
    
    .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        padding-left: 10px;
    }
    
    .log-error { border-left-color: #dc3545; }
    .log-success { border-left-color: #28a745; }
    .log-warning { border-left-color: #ffc107; }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    @media (max-width: 768px) {
        .test-form {
            flex-direction: column;
            align-items: stretch;
        }
        
        .test-form input,
        .test-form button {
            width: 100%;
        }
    }
</style>

<script is:inline>
// ç²å– API åŸºç¤åœ°å€
const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
    ? 'http://localhost:3001' 
    : 'https://x.soundjaeger.com:3001';

// æ—¥èªŒå‡½æ•¸
function addLog(message, type = 'info') {
    const logContainer = document.getElementById('log-container');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
function updateStatus(elementId, status, message = '') {
    const element = document.getElementById(elementId);
    if (element) {
        element.className = `status-indicator status-${status}`;
        element.textContent = status === 'success' ? 'âœ“' : 
                             status === 'error' ? 'âœ—' : 
                             status === 'warning' ? 'âš ' : 'â³';
        if (message) {
            element.title = message;
        }
    }
}

// æª¢æŸ¥ API æœå‹™å™¨
async function checkApiServer() {
    try {
        addLog('æª¢æŸ¥ API æœå‹™å™¨é€£æ¥...');
        const response = await fetch(`${apiBase}/api/health`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateStatus('api-status', 'success', 'API æœå‹™å™¨æ­£å¸¸');
            addLog('API æœå‹™å™¨é€£æ¥æˆåŠŸ', 'success');
            return true;
        } else {
            updateStatus('api-status', 'error', `HTTP ${response.status}`);
            addLog(`API æœå‹™å™¨è¿”å›éŒ¯èª¤: ${response.status}`, 'error');
            return false;
        }
    } catch (error) {
        updateStatus('api-status', 'error', error.message);
        addLog(`API æœå‹™å™¨é€£æ¥å¤±æ•—: ${error.message}`, 'error');
        return false;
    }
}

// æª¢æŸ¥æ•¸æ“šåº«é€£æ¥
async function checkDatabase() {
    try {
        addLog('æª¢æŸ¥æ•¸æ“šåº«é€£æ¥...');
        const response = await fetch(`${apiBase}/api/db-status`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateStatus('db-status', 'success', 'æ•¸æ“šåº«é€£æ¥æ­£å¸¸');
            addLog('æ•¸æ“šåº«é€£æ¥æˆåŠŸ', 'success');
            return true;
        } else {
            updateStatus('db-status', 'error', 'æ•¸æ“šåº«é€£æ¥å¤±æ•—');
            addLog('æ•¸æ“šåº«é€£æ¥å¤±æ•—', 'error');
            return false;
        }
    } catch (error) {
        updateStatus('db-status', 'error', error.message);
        addLog(`æ•¸æ“šåº«æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
        return false;
    }
}

// æª¢æŸ¥èªè­‰ç³»çµ±
async function checkAuth() {
    try {
        addLog('æª¢æŸ¥ç”¨æˆ¶èªè­‰ç³»çµ±...');
        const response = await fetch('/js/membership-auth.js');
        if (response.ok) {
            updateStatus('auth-status', 'success', 'èªè­‰ç³»çµ±æ–‡ä»¶æ­£å¸¸');
            addLog('èªè­‰ç³»çµ±æ–‡ä»¶åŠ è¼‰æˆåŠŸ', 'success');
            return true;
        } else {
            updateStatus('auth-status', 'error', 'èªè­‰æ–‡ä»¶åŠ è¼‰å¤±æ•—');
            addLog('èªè­‰ç³»çµ±æ–‡ä»¶åŠ è¼‰å¤±æ•—', 'error');
            return false;
        }
    } catch (error) {
        updateStatus('auth-status', 'error', error.message);
        addLog(`èªè­‰ç³»çµ±æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
        return false;
    }
}

// æª¢æŸ¥éœæ…‹æ–‡ä»¶æœå‹™
async function checkStaticFiles() {
    try {
        addLog('æª¢æŸ¥éœæ…‹æ–‡ä»¶æœå‹™...');
        const response = await fetch('/js/notification-system.js');
        if (response.ok) {
            updateStatus('static-status', 'success', 'éœæ…‹æ–‡ä»¶æœå‹™æ­£å¸¸');
            addLog('éœæ…‹æ–‡ä»¶æœå‹™æ­£å¸¸', 'success');
            return true;
        } else {
            updateStatus('static-status', 'error', 'éœæ…‹æ–‡ä»¶æœå‹™ç•°å¸¸');
            addLog('éœæ…‹æ–‡ä»¶æœå‹™ç•°å¸¸', 'error');
            return false;
        }
    } catch (error) {
        updateStatus('static-status', 'error', error.message);
        addLog(`éœæ…‹æ–‡ä»¶æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
        return false;
    }
}

// æª¢æŸ¥é€šçŸ¥ç³»çµ±
function checkNotificationSystem() {
    try {
        addLog('æª¢æŸ¥é€šçŸ¥ç³»çµ±...');
        if (typeof window.notify !== 'undefined') {
            updateStatus('notify-status', 'success', 'é€šçŸ¥ç³»çµ±æ­£å¸¸');
            addLog('é€šçŸ¥ç³»çµ±å·²åŠ è¼‰ä¸¦å¯ç”¨', 'success');
        } else {
            // å˜—è©¦åŠ è¼‰é€šçŸ¥ç³»çµ±è…³æœ¬
            const script = document.createElement('script');
            script.src = '/js/notification-system.js';
            script.onload = () => {
                setTimeout(() => {
                    if (typeof window.notify !== 'undefined') {
                        updateStatus('notify-status', 'success', 'é€šçŸ¥ç³»çµ±æ­£å¸¸');
                        addLog('é€šçŸ¥ç³»çµ±åŠ è¼‰æˆåŠŸ', 'success');
                    } else {
                        updateStatus('notify-status', 'warning', 'é€šçŸ¥ç³»çµ±éƒ¨åˆ†åŠŸèƒ½ç•°å¸¸');
                        addLog('é€šçŸ¥ç³»çµ±åŠ è¼‰ä½†åŠŸèƒ½ç•°å¸¸', 'warning');
                    }
                }, 100);
            };
            script.onerror = () => {
                updateStatus('notify-status', 'error', 'é€šçŸ¥ç³»çµ±åŠ è¼‰å¤±æ•—');
                addLog('é€šçŸ¥ç³»çµ±åŠ è¼‰å¤±æ•—', 'error');
            };
            document.head.appendChild(script);
        }
    } catch (error) {
        updateStatus('notify-status', 'error', error.message);
        addLog(`é€šçŸ¥ç³»çµ±æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
    }
}

// æ¸¬è©¦ç™»éŒ„
async function testLogin() {
    const email = document.getElementById('test-email').value;
    const password = document.getElementById('test-password').value;
    
    if (!email || !password) {
        addLog('è«‹è¼¸å…¥éƒµç®±å’Œå¯†ç¢¼', 'error');
        return;
    }
    
    try {
        addLog(`é–‹å§‹æ¸¬è©¦ç™»éŒ„: ${email}`);
        const response = await fetch(`${apiBase}/api/signin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            addLog(`ç™»éŒ„æ¸¬è©¦æˆåŠŸ! Token: ${data.token?.substring(0, 20)}...`, 'success');
            addLog(`ç”¨æˆ¶ä¿¡æ¯: ${JSON.stringify(data.user)}`, 'success');
        } else {
            addLog(`ç™»éŒ„æ¸¬è©¦å¤±æ•—: ${data.error}`, 'error');
        }
    } catch (error) {
        addLog(`ç™»éŒ„æ¸¬è©¦ç•°å¸¸: ${error.message}`, 'error');
    }
}

// æ¸¬è©¦è¨»å†Š
async function testSignup() {
    const email = document.getElementById('test-email').value;
    const password = document.getElementById('test-password').value;
    
    if (!email || !password) {
        addLog('è«‹è¼¸å…¥éƒµç®±å’Œå¯†ç¢¼', 'error');
        return;
    }
    
    try {
        addLog(`é–‹å§‹æ¸¬è©¦è¨»å†Š: ${email}`);
        const response = await fetch(`${apiBase}/api/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name: 'Test User',
                username: email,
                email: email,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            addLog(`è¨»å†Šæ¸¬è©¦æˆåŠŸ!`, 'success');
        } else {
            addLog(`è¨»å†Šæ¸¬è©¦å¤±æ•—: ${data.error}`, 'error');
            if (data.details) {
                addLog(`è©³ç´°ä¿¡æ¯: ${JSON.stringify(data.details)}`, 'error');
            }
        }
    } catch (error) {
        addLog(`è¨»å†Šæ¸¬è©¦ç•°å¸¸: ${error.message}`, 'error');
    }
}

// åˆ·æ–°ç‹€æ…‹
async function refreshStatus() {
    addLog('åˆ·æ–°ç³»çµ±ç‹€æ…‹...', 'info');
    
    // é‡ç½®æ‰€æœ‰ç‹€æ…‹ç‚ºåŠ è¼‰ä¸­
    ['api-status', 'auth-status', 'db-status', 'static-status', 'notify-status'].forEach(id => {
        updateStatus(id, 'loading');
    });
    
    // é‡æ–°æª¢æŸ¥æ‰€æœ‰çµ„ä»¶
    await runSystemCheck();
    
    addLog('ç‹€æ…‹åˆ·æ–°å®Œæˆ', 'success');
}

// æ›´æ–°ç³»çµ±ä¿¡æ¯
function updateSystemInfo() {
    const currentTime = document.getElementById('current-time');
    const browserInfo = document.getElementById('browser-info');
    const connectionInfo = document.getElementById('connection-info');
    
    if (currentTime) {
        currentTime.textContent = new Date().toLocaleString();
    }
    
    if (browserInfo) {
        browserInfo.textContent = navigator.userAgent.split(' ').pop();
    }
    
    if (connectionInfo) {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (connection) {
            connectionInfo.textContent = `${connection.effectiveType || 'unknown'} (${connection.downlink || 'unknown'}Mbps)`;
        } else {
            connectionInfo.textContent = navigator.onLine ? 'åœ¨ç·š' : 'é›¢ç·š';
        }
    }
}

// é‹è¡Œç³»çµ±æª¢æŸ¥
async function runSystemCheck() {
    addLog('é–‹å§‹ç³»çµ±ç‹€æ…‹æª¢æŸ¥...', 'info');
    
    // ä¾æ¬¡æª¢æŸ¥å„å€‹çµ„ä»¶
    await checkApiServer();
    await checkDatabase();
    await checkAuth();
    await checkStaticFiles();
    checkNotificationSystem();
    
    addLog('ç³»çµ±ç‹€æ…‹æª¢æŸ¥å®Œæˆ', 'success');
}

// é é¢åŠ è¼‰æ™‚é–‹å§‹æª¢æŸ¥
document.addEventListener('DOMContentLoaded', async function() {
    updateSystemInfo();
    await runSystemCheck();
    
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ™‚é–“
    setInterval(updateSystemInfo, 30000);
});

// ç¶²çµ¡ç‹€æ…‹è®ŠåŒ–ç›£è½
window.addEventListener('online', () => {
    addLog('ç¶²çµ¡é€£æ¥å·²æ¢å¾©', 'success');
    updateSystemInfo();
});

window.addEventListener('offline', () => {
    addLog('ç¶²çµ¡é€£æ¥å·²æ–·é–‹', 'error');
    updateSystemInfo();
});
</script>
