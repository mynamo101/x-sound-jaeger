---
import globalSettings from '@config/config.json.ts';
import BaseLayout from "@layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import default_avatar from "@assets/images/account/account.jpg"

import "@styles/hero.css"
import "@styles/author.css"
import "@styles/account.css"

const t = await import(/* @vite-ignore */ `@locales/${globalSettings.language}.json`)
    .catch(() => import(/* @vite-ignore */ '@locales/en.json'));

---

<BaseLayout globalSettings={globalSettings} t={t} title={t.account_page.title_hero} description={t.account_page.full_name_value}>
        <main>
                <section class="hero account-page-hero">
                        <div class="wide-container">
                                <div class="hero-wrapper">
                                        <div class:list={['hero-top-border', { 'horizontal-line-animation': globalSettings.use_page_load_animations }]}></div>
                                        <div class="hero-text-wrapper section-padding-bottom">               
                                                <div class="hero-heading-wrapper section-padding-top">               
                                                        <h1 class:list={[{ 'letter-animation': globalSettings.use_page_load_animations }]}>{t.account_page.title_hero}</h1>                  
                                                        <h3 class:list={['hero-number', { 'hero-number-animation': globalSettings.use_page_load_animations }]}></h3>
                                                </div>
                                        </div>                    <div class:list={['account-buttons section-padding-bottom', { 'vertical-animation': globalSettings.use_page_load_animations }]} data-delay="400">
                                                <a href="#" class="button account-button" id="settings-button">
                                                        {t.account_page.settings}
                                                </a>
                                                <a href="#" class="button account-button" id="logout-button">
                                                        {t.account_page.log_out}
                                                </a>
                                                <a href="/signin" class="button account-button" id="login-button" style="display: none;">
                                                        {globalSettings.language === 'zh' ? '登录' : 'Log In'}
                                                </a>
                                        </div>

                                        <div class="author-bottom-line-left">
                                                <div class:list={['hero-bottom-border', { 'horizontal-line-animation': globalSettings.use_page_load_animations }]}></div>
                                        </div>
                                        <div class="author-bottom-line-right">
                                                <div class:list={['hero-bottom-border', { 'horizontal-line-animation': globalSettings.use_page_load_animations }]}></div>
                                        </div>
                                </div>
                        </div>
                </section>

                <section class="wide-container">
                        <div class:list={['author-info section-padding-bottom-extra', { 'hidden-animation': globalSettings.use_page_load_animations }]} >                                <div class="author-text-content-wrapper">            
                                        <div class="author-text-content">                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.login_status_label}</h3>
                                                                <div class="medium-text" id="account-login-status" title="点击查看详细信息">
                                                                        <span id="login-status-text">{t.account_page.not_logged_in}</span>
                                                                        <span id="login-status-indicator" class="status-indicator not-logged-in">●</span>
                                                                        <span id="login-time" class="login-time" style="display: none;"></span>
                                                                </div>
                                                        </div>
                                                </div>

                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.full_name_label}</h3>
                                                                <div class="medium-text" id="account-fullname"></div>
                                                        </div>
                                                </div>

                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.email_label}</h3>
                                                                <div class="medium-text" id="account-email"></div>
                                                        </div>
                                                </div>

                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.current_plan_label}</h3>
                                                                <div class="medium-text" id="account-tier"></div>
                                                        </div>
                                                </div>

                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.card_label}</h3>
                                                                <div class="medium-text" id="account-card">—</div>
                                                        </div>
                                                </div>

                                                <div class="author-info-row author-info-count">
                                                        <div class="author-info-row-inner">
                                                                <h3>{t.account_page.billing_date_label}</h3>
                                                                <div class="medium-text" id="account-billing-date">—</div>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
        
                                <div class="author-image-wrapper section-padding-top">
                                        <div class="card-image" >                                                <figure class="author-figure">
                                                        <Image 
                                                                src={default_avatar as any}
                                                                alt={t.account_page.full_name_value}
                                                                loading="eager" 
                                                                format="webp"
                                                                widths={[300, 400, 600, 800, 1000, 1200, 1600]}
                                                                sizes="(max-width: 479px) calc(100vw - 36px), (max-width: 991px) calc(100vw - 60px), 40vw"
                                                                id="user-avatar"
                                                        />
                                                </figure>
                                        </div>
                                </div>                        </div>
                </section>        </main>
</BaseLayout>

<script>
        // API function
        async function getUserProfile(token) {
                const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                        ? 'http://localhost:3001'
                        : 'https://x.soundjaeger.com';
                return fetch(`${apiBase}/api/user/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                });
        }

        // 登录检查和自动跳转
        function checkAuthAndRedirect() {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                        console.log('[Account] Not logged in, redirecting to signin');
                        // 如果没有登录，立即跳转到登录页面
                        window.location.replace('/signin/');
                        return false;
                }
                return true;
        }

        // 立即执行登录检查，在DOM加载前
        if (!checkAuthAndRedirect()) {
                // 如果没有登录，停止执行后续代码
                throw new Error('Not logged in, redirecting...');
        }

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
                // 再次检查登录状态（防止localStorage在页面加载期间被清除）
                if (!checkAuthAndRedirect()) {
                        return;
                }
                
                console.log('[Account] DOM loaded, start loading user data');
                loadAccountData();
                setupLoginStatusClick();
                
                // Update active time every minute
                setInterval(updateActiveTime, 60000);
                
                // Set hero number
                const heroNumber = document.querySelector('.hero-number');
                const infoCount = document.querySelectorAll('.author-info-count').length;
                if (heroNumber) {
                        heroNumber.innerHTML = infoCount.toString();
                }

                // Set logout button
                const logoutButton = document.getElementById('logout-button');
                if (logoutButton) {
                        logoutButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                handleLogout();
                        });
                }
        });        // 只保留字串映射，不再支援數字
        function getUserTierDisplayName(tier) {
                // 允許小寫、空值、'-' 都有對應
                if (!tier || tier === '-' || tier === 'null' || tier === 'undefined') return 'Free';
                const tierMap = {
                        'Free': 'Free',
                        'free': 'Free',
                        'Starter': 'Starter',
                        'starter': 'Starter',
                        'Explorer': 'Explorer',
                        'explorer': 'Explorer',
                        'Creator': 'Creator',
                        'creator': 'Creator',
                };
                return tierMap[tier] || tier;
        }        // 更新用户头像
        function updateUserAvatar(user) {
                const avatarImg = document.getElementById('user-avatar') as HTMLImageElement;
                if (!avatarImg) return;
                
                // 如果用户有自定义头像URL，使用用户头像
                if (user.avatar_url && user.avatar_url.trim()) {
                        avatarImg.src = user.avatar_url;
                        avatarImg.alt = `${user.name || user.username}'s avatar`;
                } else {
                        // 否则保持默认头像
                        avatarImg.alt = `${user.name || user.username || 'User'}'s default avatar`;
                }
                
                // 添加头像加载错误处理
                avatarImg.onerror = function() {
                        console.warn('[Account] Failed to load user avatar, using default');
                        // 如果用户头像加载失败，恢复为默认头像 - 使用默认图片的实际路径                        (this as HTMLImageElement).src = '/src/assets/images/account/account.jpg';
                        (this as HTMLImageElement).alt = 'Default user avatar';
                };
        }        async function handleLogout() {
                console.log('[Account] Logging out...');
                
                // Clear localStorage
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                localStorage.removeItem('login_time');
                
                // Show logout success message
                if ((window as any).notify) {
                    (window as any).notify.success('Logged out successfully', {
                        title: 'Goodbye'
                    });
                    
                    // Delay redirect to show notification
                    setTimeout(() => {
                        window.location.href = '/signin/';
                    }, 1000);
                } else {
                    // Fallback if notification system is not available
                    window.location.href = '/signin/';
                }
        }async function loadAccountData() {
                console.log('[Account] Start loading user data');
                
                // Check if elements exist
                const fullnameEl = document.getElementById('account-fullname');
                const emailEl = document.getElementById('account-email');
                const tierEl = document.getElementById('account-tier');
                const loginStatusTextEl = document.getElementById('login-status-text');
                const loginStatusIndicatorEl = document.getElementById('login-status-indicator');
                
                if (!fullnameEl || !emailEl || !tierEl || !loginStatusTextEl || !loginStatusIndicatorEl) {
                        console.error('[Account] Required elements not found:', {
                                fullnameEl: !!fullnameEl,
                                emailEl: !!emailEl,
                                tierEl: !!tierEl,
                                loginStatusTextEl: !!loginStatusTextEl,
                                loginStatusIndicatorEl: !!loginStatusIndicatorEl
                        });
                        return;
                }

                // Get cached data from localStorage
                const token = localStorage.getItem('auth_token');
                const userInfoStr = localStorage.getItem('user_info');
                
                console.log('[Account] localStorage data:', { 
                        hasToken: !!token, 
                        hasUserInfo: !!userInfoStr 
                });                // Update login status display
                function updateLoginStatus(isLoggedIn, loginTime = null) {
                        const settingsButton = document.getElementById('settings-button');
                        const logoutButton = document.getElementById('logout-button');
                        const loginButton = document.getElementById('login-button');
                        const loginTimeEl = document.getElementById('login-time');
                        
                        if (isLoggedIn) {
                                loginStatusTextEl.innerText = document.documentElement.lang === 'zh' ? '已登录' : 'Logged In';
                                loginStatusTextEl.className = 'logged-in';
                                loginStatusIndicatorEl.className = 'status-indicator logged-in';
                                  // Show login time if available
                                if (loginTime && loginTimeEl) {
                                        const timeText = document.documentElement.lang === 'zh' ? 
                                                `${loginTime}` : 
                                                `${loginTime}`;
                                        loginTimeEl.innerText = timeText;
                                        loginTimeEl.style.display = 'inline';
                                }
                                
                                // Show logged-in buttons
                                if (settingsButton) settingsButton.style.display = 'flex';
                                if (logoutButton) logoutButton.style.display = 'flex';
                                if (loginButton) loginButton.style.display = 'none';
                        } else {
                                loginStatusTextEl.innerText = document.documentElement.lang === 'zh' ? '未登录' : 'Not Logged In';
                                loginStatusTextEl.className = 'not-logged-in';
                                loginStatusIndicatorEl.className = 'status-indicator not-logged-in';
                                
                                // Hide login time
                                if (loginTimeEl) loginTimeEl.style.display = 'none';
                                
                                // Show login button only
                                if (settingsButton) settingsButton.style.display = 'none';
                                if (logoutButton) logoutButton.style.display = 'none';
                                if (loginButton) loginButton.style.display = 'flex';
                        }
                }                if (!token) {
                        console.log('[Account] Not logged in, redirecting...');
                        window.location.replace('/signin/');
                        return;
                }// User is logged in
                const loginTime = localStorage.getItem('login_time');
                let formattedLoginTime = null;
                
                if (loginTime) {
                        const loginDate = new Date(parseInt(loginTime));
                        // 只显示年/月/日
                        formattedLoginTime = loginDate.toLocaleDateString(document.documentElement.lang === 'zh' ? 'zh-CN' : 'en-US');
                }
                
                updateLoginStatus(true, formattedLoginTime);
                
                // Update page title to show login status
                document.title = `${document.title} - ${document.documentElement.lang === 'zh' ? '已登录' : 'Logged In'}`;

                // Show cached data
                if (userInfoStr) {
                        try {                                const user = JSON.parse(userInfoStr);
                                console.log('[Account] Show cached data:', user);
                                fullnameEl.innerText = user.name || user.username || user.email || '-';
                                emailEl.innerText = user.email || user.username || '-';
                                // 這裡強制映射 tier 顯示
                                tierEl.innerText = getUserTierDisplayName(user.tier);
                                // 更新用户头像
                                updateUserAvatar(user);
                        } catch (e) {
                                console.error('[Account] Failed to parse cached data:', e);
                        }
                }                // Fetch latest data from server
                try {
                        console.log('[Account] Requesting latest data from API...');
                        const response = await getUserProfile(token);

                        console.log('[Account] API response status:', response.status);

                        if (response.ok) {
                                const data = await response.json();
                                console.log('[Account] API response data:', data);
                                const userInfo = {
                                        ...data.user,
                                        tier: data.user.tier || 'Free'
                                };

                                // Update display
                                fullnameEl.innerText = userInfo.name || userInfo.username || userInfo.email || '-';
                                emailEl.innerText = userInfo.email || userInfo.username || '-';
                                // 這裡強制映射 tier 顯示
                                tierEl.innerText = getUserTierDisplayName(userInfo.tier);

                                // Update localStorage
                                localStorage.setItem('user_info', JSON.stringify(userInfo));
                                console.log('[Account] Data updated');                        } else if (response.status === 401 || response.status === 403) {
                                console.log('[Account] Authentication expired, clearing data');
                                localStorage.removeItem('auth_token');
                                localStorage.removeItem('user_info');
                                updateLoginStatus(false);
                                fullnameEl.innerText = document.documentElement.lang === 'zh' ? '请先登录' : 'Please log in first';
                                emailEl.innerText = '-';
                                tierEl.innerText = '-';
                        } else {
                                console.error('[Account] API error:', response.status);
                        }
                } catch (error) {
                        console.error('[Account] Network error:', error);
                        // Keep current display on network error
                }
        }        // Update active session time
        function updateActiveTime() {
                const loginTime = localStorage.getItem('login_time');
                const loginTimeEl = document.getElementById('login-time');
                
                if (loginTime && loginTimeEl && loginTimeEl.style.display !== 'none') {
                        const loginTimestamp = parseInt(loginTime);
                        const nowTimestamp = Date.now();
                        const diffInMinutes = Math.floor((nowTimestamp - loginTimestamp) / (1000 * 60));
                        
                        let timeText;
                        if (document.documentElement.lang === 'zh') {
                                if (diffInMinutes < 1) {
                                        timeText = '刚刚登录';
                                } else if (diffInMinutes < 60) {
                                        timeText = `${diffInMinutes}分钟前登录`;
                                } else {
                                        const hours = Math.floor(diffInMinutes / 60);
                                        timeText = `${hours}小时前登录`;
                                }
                        } else {
                                if (diffInMinutes < 1) {
                                        timeText = 'Just logged in';
                                } else if (diffInMinutes < 60) {
                                        timeText = `Logged in ${diffInMinutes}m ago`;
                                } else {
                                        const hours = Math.floor(diffInMinutes / 60);
                                        timeText = `Logged in ${hours}h ago`;
                                }
                        }
                        
                        loginTimeEl.innerText = timeText;
                }
        }

        // Add click handler for login status
        function setupLoginStatusClick() {
                const loginStatusEl = document.getElementById('account-login-status');
                const loginTimeEl = document.getElementById('login-time');
                
                if (loginStatusEl && loginTimeEl) {
                        loginStatusEl.style.cursor = 'pointer';
                        loginStatusEl.addEventListener('click', function() {
                                const token = localStorage.getItem('auth_token');
                                if (token) {
                                        if (loginTimeEl.style.display === 'none') {
                                                updateActiveTime();
                                                loginTimeEl.style.display = 'inline';
                                        } else {
                                                loginTimeEl.style.display = 'none';
                                        }
                                }
                        });
                }
        }

        // Initial setup
        setupLoginStatusClick();

        // Update active time every minute
        setInterval(updateActiveTime, 60 * 1000);
</script>